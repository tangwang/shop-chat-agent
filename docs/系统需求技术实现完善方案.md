# 系统需求技术实现完善方案（结合当前项目）

## 1. 目标与现状对齐

当前仓库是一个可运行的 Shopify 聊天导购系统，已有能力包括：
- `/chat` 路由承接对话请求与 SSE 流式返回；
- LLM 调用与工具调用循环（Claude + MCP tools）；
- 会话消息持久化与历史回放；
- 前端聊天组件渲染文本与商品结果。

基于此，建议采用**“渐进式增强”**而非重写：保留现有 `chat` 主链路，在其前后插入「编排层」「用户理解」「商品理解概览」「评估与日志」能力，逐步演进到文档中定义的目标系统。

---

## 2. 建议的目录结构（增量）

> 说明：以下为建议结构，兼容现有 Node/React Router 主工程；其中 Python/LangChain 子模块可独立目录运行。

```text
.
├── app/                               # 现有在线服务（保留）
│   ├── routes/chat.jsx                # 主对话入口
│   └── services/
│       ├── claude.server.js
│       ├── tool.server.js
│       ├── streaming.server.js
│       └── ...
├── assistant/                         # 新增：导购与编排层（建议 Python）
│   ├── orchestrator/
│   ├── responder/
│   ├── prompts/
│   └── docs/
├── product_understanding/             # 新增：商品理解（离线 + 在线查询接口）
│   ├── process_products.py            # 已有（来自需求）
│   ├── output_logs/
│   ├── service/
│   └── docs/
├── user_understanding/                # 新增：用户画像与记忆
│   ├── profile_builder/
│   ├── mock_input_api/
│   └── docs/
├── evaluation/                        # 新增：评估脚本与基准集
│   ├── datasets/
│   ├── prompts/
│   ├── runners/
│   └── reports/
├── data/                              # 新增：共享数据、样例与缓存
├── Logs/                              # 新增：模块级日志
│   ├── assistant_*.log
│   ├── product_understanding_*.log
│   └── user_understanding_*.log
└── scripts/
    ├── start_product_module.sh
    ├── start_user_module.sh
    ├── start_agent_module.sh
    └── start_web.sh
```

---

## 3. 模块级实现完善建议

### 3.1 assistant（导购智能体）

#### A. 双阶段执行模型（强烈建议）
1. **阶段1：Orchestrator（编排）**
   - 输入：用户输入 + 最近对话 + 用户画像摘要 + 商店分布摘要 + 时空上下文。
   - 输出：结构化 `plan` JSON（goal、gaps、tool_plan、questions、strategy）。
2. **阶段2：Assistant（面向用户回复）**
   - 输入：`plan` + 工具执行结果 + 对话上下文。
   - 输出：自然语言回复（补信息 + 推荐 + 轻引导）。

#### B. 与当前实现的落地点
- 在现有 `app/routes/chat.jsx` 中 `while (finalMessage.stop_reason !== "end_turn")` 循环前，新增 `orchestrator` 调用；
- 在工具执行后，把工具结果与 `orchestrator plan` 一起注入到最终回复生成的系统上下文。

#### C. 输出约束
- 建议优先采用“Function Calling / JSON Schema 强约束”。
- 若模型能力受限，退化为 `<ORCHESTRATION>{...}</ORCHESTRATION>` 包裹 + JSON 解析兜底。

#### D. 关键输入输出（I/O）
- 输入：
  - `user_text`
  - `recent_dialogue`
  - `user_profile_markdown`
  - `store_distribution_summary`
  - `season_context`
- 输出：
  - `plan.stage`
  - `plan.intent`
  - `plan.gap_assessment`
  - `plan.tool_plan[]`
  - `plan.questions_to_ask[]`
  - `plan.response_strategy`

---

### 3.2 product_understanding（商品理解）

#### A. 离线统计层（优先落地）
已知 `products_analyzed.csv` 可直接复用，下一步做：
1. 各维度 TopN 统计（品类、标签、人群、场景、感觉）；
2. 归一化映射（raw -> normalized）；
3. 每个 normalized key 的概览卡（数量、代表商品、典型特征）；
4. 生成店铺“内容分布简介”；
5. 生成店铺欢迎语候选（10 条）。

#### B. 在线查询层（供编排器调用）
暴露轻量接口（可 Python FastAPI）：
- `GET /distribution?dimension=category&key=裙子`
- `GET /keys?dimension=style`
- `GET /store-summary`
- `GET /welcome-candidates`

#### C. 搜索技能落地分层
- `product_search_fuzzy`: 意图宽泛时按维度 key 拉概览。
- `product_search_precise`: 关键词明确时调用搜索 API。
- `result_summarize`: 对 top30 做满足度判断、query 改写、精选商品输出。

#### D. 关键输入输出（I/O）
- 输入：`dimension`, `normalized_key`, `intent_slots`, `search_query`。
- 输出：`distribution_markdown`, `candidate_products`, `improved_query`, `selection_reason`。

---

### 3.3 user_understanding（用户理解）

#### A. “前端 Mock + 后端生成画像”模式
与需求一致，先不接真实埋点系统：
1. 前端维护点击/加购/购买/搜索/历史会话 mock 数据；
2. 点击“更新画像”触发后端 summarizer；
3. 输出 markdown 画像 + 更新时间 + 触发事件类型。

#### B. 画像结构建议（固定模板）
- `Slow-changing Preferences`
- `Semi-stable Context`
- `Hard Constraints`
- `Evidence`（每条偏好都附证据来源）

#### C. 会话结束增量更新（后续阶段）
- 在每次对话结束事件触发 `profile_delta_update`，将本轮新信息合并进长期画像。

#### D. 关键输入输出（I/O）
- 输入：历史行为（点击/加购/购买）、搜索记录、压缩对话记录。
- 输出：`profile_markdown`, `personalized_greeting`, `offline_reco_list`。

---

## 4. 动态编排层（Orchestrator）建议细化

### 4.1 触发与流程
- 用户发言 -> `intent_parse` -> `gap_assessment` -> `tool_plan` -> 执行工具 -> Assistant 回复。

### 4.2 缺口判定策略
- 缺口大：
  - 最多问 1~2 个用户立场问题；
  - 同时给 2~3 个临时推荐方向。
- 缺口小：
  - 直接检索、对比、搭配并给出建议。

### 4.3 Web Search 触发门控（强门控）
仅在以下情况触发：
1. 用户提及时效趋势；
2. 用户描述需求但不知道品类名；
3. 新概念术语需解释。

避免将 web_search 作为常规路径，控制时延与成本。

---

## 5. 日志与可观测性（必须落地）

### 5.1 日志规范
每个模块独立前缀文件：
- `Logs/assistant_YYYYMMDD.log`
- `Logs/product_understanding_YYYYMMDD.log`
- `Logs/user_understanding_YYYYMMDD.log`

### 5.2 LLM 调用日志建议字段
- `trace_id`, `session_id`, `module`, `model`, `latency_ms`, `token_usage`
- `prompt_version`, `input_digest`, `output_digest`
- `tool_calls[]`, `error`

> 注意：完整 prompt / 用户隐私建议脱敏后落盘。

---

## 6. 评估体系（测试驱动开发）

### 6.1 离线评估集合
- 场景覆盖：意图不明确 / 明确检索 / 对比决策 / 搭配建议 / 约束冲突。
- 每个样本包含：输入、期望行为（而非唯一话术）、评分维度。

### 6.2 评估维度
- 意图识别完整度
- 提问质量（是否“用户立场”）
- 推荐相关性
- 工具调用正确率
- 回复可执行性（下一步行动清晰）
- 对话推进率（是否促成继续交流/转化）

### 6.3 LLM-as-a-Judge
- 用单独评估模型执行打分；
- 采用 rubric + few-shot 降低波动；
- 保留人工抽检集作为校准。

---

## 7. 与当前项目的集成路径（四阶段）

### Phase 1（低风险）
- 仅新增文档、数据结构、日志规范；
- 在现有 chat 里插入“伪编排器”（先固定 JSON 结构）。

### Phase 2（中风险）
- 上线 product_understanding 在线查询 API；
- 接入 fuzzy / precise / summarize 三个搜索技能。

### Phase 3（中风险）
- 上线 user_understanding 的 mock 输入与画像生成；
- 支持个性化欢迎语和离线推荐列表。

### Phase 4（高价值）
- 引入严格 Function Calling 规划；
- 完成 evaluation 自动化回归与阈值守门（CI）。

---

## 8. scripts 建议职责

- `scripts/start_product_module.sh`：启动商品理解 API 与离线缓存服务。
- `scripts/start_user_module.sh`：启动用户画像 mock API。
- `scripts/start_agent_module.sh`：启动编排器 + 导购 responder 服务。
- `scripts/start_web.sh`：启动现有 Web（端口 6008）。

---

## 9. 风险与规避

1. **模型输出不稳定**：必须 JSON schema 校验 + 重试 + 兜底策略。
2. **工具链路过长**：设置工具调用上限与超时策略。
3. **响应慢**：并行可并行的工具调用；web search 强门控。
4. **提示词漂移**：prompt 版本化管理（含回滚）。

---

## 10. 最小可交付（建议本迭代目标）

1. Orchestrator 结构化 plan（可解析）。
2. 商品分布查询 API（至少 category/tag/scene 三维）。
3. 用户画像 markdown 生成（前端 mock 驱动）。
4. 模块级日志 + 一套离线评估脚本。

以上四项完成后，即可形成“可解释、可评估、可迭代”的导购智能体闭环。
